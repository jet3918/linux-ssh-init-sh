name: Test Matrix

on: [push, pull_request]

jobs:
  test-distros:
    # å…³é”®ç‚¹ 1: åœ¨ Ubuntu å®¿ä¸»æœºä¸Šè¿è¡Œ Jobï¼Œè€Œä¸æ˜¯ç›´æ¥åœ¨å®¹å™¨é‡Œè·‘
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        container:
          - 'debian:11'
          - 'debian:12'
          - 'ubuntu:22.04'
          - 'alpine:latest'
          - 'almalinux:9'
          - 'rockylinux:9'
          - 'centos:7'                        # è¿™é‡Œçš„ CentOS 7 ç°åœ¨å¯ä»¥è·‘äº†ï¼
          - 'quay.io/centos/centos:stream9'

    steps:
      # å…³é”®ç‚¹ 2: åœ¨å®¿ä¸»æœºä¸Šæ£€å‡ºä»£ç  (Ubuntu æ”¯æŒ Node20ï¼Œæ²¡é—®é¢˜)
      - name: Checkout code
        uses: actions/checkout@v4

      # å…³é”®ç‚¹ 3: ä½¿ç”¨ docker run æ‰‹åŠ¨å¯åŠ¨å®¹å™¨å¹¶æŒ‚è½½ä»£ç 
      - name: Run Test in Container
        run: |
          # æ‰“å°å½“å‰æµ‹è¯•çš„é•œåƒ
          echo "ğŸš€ Testing on image: ${{ matrix.container }}"
          
          # èµ‹äºˆè„šæœ¬æ‰§è¡Œæƒé™
          chmod +x init.sh

          # å¯åŠ¨ Docker å®¹å™¨è¿è¡Œæµ‹è¯•é€»è¾‘
          # --rm: è·‘å®Œåˆ é™¤
          # --privileged: å…è®¸ä¿®æ”¹ç³»ç»Ÿå‚æ•°
          # -v $(pwd):/mnt: æŠŠå½“å‰å®¿ä¸»æœºçš„ä»£ç æŒ‚è½½åˆ°å®¹å™¨çš„ /mnt ç›®å½•
          docker run --rm --privileged -v $(pwd):/mnt -w /mnt ${{ matrix.container }} /bin/sh -c '
            
            # === ç¬¬ä¸€æ­¥ï¼šä¿®å¤ CentOS 7 EOL æº (èµ·æ­»å›ç”Ÿ) ===
            if [ -f /etc/redhat-release ] && grep -q "CentOS Linux 7" /etc/redhat-release; then
              echo "Fixing CentOS 7 EOL repos..."
              sed -i "s/mirrorlist/#mirrorlist/g" /etc/yum.repos.d/CentOS-Base.repo
              sed -i "s|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g" /etc/yum.repos.d/CentOS-Base.repo
            fi

            # === ç¬¬äºŒæ­¥ï¼šç¯å¢ƒè¡¥å…¨ (å®‰è£… sudo, curl, sshd, ç”Ÿæˆ key) ===
            echo "Installing dependencies..."
            
            # Debian / Ubuntu
            if [ -f /etc/debian_version ]; then
              apt-get update -y && apt-get install -y curl sudo openssh-server
              ssh-keygen -A
              mkdir -p /run/sshd
            fi

            # Alpine
            if [ -f /etc/alpine-release ]; then
              apk add --no-cache curl sudo openssh-server bash
              ssh-keygen -A
            fi

            # RHEL / CentOS / Alma / Rocky
            if [ -f /etc/redhat-release ]; then
              # AlmaLinux 9 è§£å†³ curl-minimal å†²çª
              if command -v dnf >/dev/null; then
                dnf install -y --allowerasing curl sudo openssh-server
              else
                yum install -y curl sudo openssh-server
              fi
              ssh-keygen -A
              mkdir -p /run/sshd
            fi

            # === ç¬¬ä¸‰æ­¥ï¼šè¿è¡Œä½ çš„è„šæœ¬ ===
            echo "Running init script..."
            ./init.sh --user=root --port=2222 --key-raw="ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPQQDejyTCPJO3Jyw5UX9jmojb/zjgcqVuRO28fmpWU5" --no-update --bbr --delay-restart --yes --strict
            
            # === ç¬¬å››æ­¥ï¼šéªŒè¯ç»“æœ ===
            if grep -q "BEGIN SERVER-INIT MANAGED BLOCK" /etc/ssh/sshd_config; then
               echo "âœ… SUCCESS: Config block injected."
            else
               echo "âŒ FAIL: Config block missing."
               exit 1
            fi
          '
