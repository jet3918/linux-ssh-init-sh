# Linux æœåŠ¡å™¨åˆå§‹åŒ–ä¸ SSH å®‰å…¨åŠ å›º

[![Test Matrix](https://github.com/247like/linux-ssh-init-sh/actions/workflows/test.yml/badge.svg)](https://github.com/247like/linux-ssh-init-sh/actions/workflows/test.yml)
![POSIX Shell](https://img.shields.io/badge/Shell-POSIX_sh-blue?style=flat-square)
[![License](https://img.shields.io/badge/License-MIT-green?style=flat-square)](LICENSE)
[![Release](https://img.shields.io/github/v/release/247like/linux-ssh-init-sh?style=flat-square)](https://github.com/247like/linux-ssh-init-sh/releases)
[![Stars](https://img.shields.io/github/stars/247like/linux-ssh-init-sh?style=flat-square)](https://github.com/247like/linux-ssh-init-sh/stargazers)

[![ä¸­æ–‡æ–‡æ¡£](https://img.shields.io/badge/ä¸­æ–‡-Chinese-blue)](README.md) [![English](https://img.shields.io/badge/English-EN-blue)](README_EN.md)

---

# æºä»“åº“https://github.com/247like/linux-ssh-init-sh

---

ä¸€ä¸ªç”Ÿäº§å°±ç»ªã€ç¬¦åˆ POSIX æ ‡å‡†çš„ Shell è„šæœ¬ï¼Œç”¨äº Linux æœåŠ¡å™¨çš„ä¸€é”®åˆå§‹åŒ–ä¸ SSH å®‰å…¨åŠ å›ºã€‚

è¯¥è„šæœ¬å¯è‡ªåŠ¨å®Œæˆ **SSH å¯†é’¥é…ç½®**ã€**ä¿®æ”¹ç«¯å£**ã€**åˆ›å»ºç”¨æˆ·**ã€**å¼€å¯ BBR** ä»¥åŠ **ç³»ç»Ÿæ›´æ–°**ï¼Œå¹¶å®Œç¾å…¼å®¹ Debian, Ubuntu, CentOS, RHEL ä»¥åŠ Alpine Linuxã€‚

### âœ¨ æ ¸å¿ƒç‰¹æ€§

* **å…¨å¹³å°å…¼å®¹**: å®Œç¾æ”¯æŒ **Debian**, **Ubuntu**, **CentOS/RHEL**, **Alma/Rocky**, ä»¥åŠ **Alpine Linux**ã€‚
* **POSIX æ ‡å‡†**: çº¯ `/bin/sh` ç¼–å†™ï¼Œæ— éœ€å®‰è£… `bash`ã€‚åœ¨ `dash` (Debian) å’Œ `ash` (Alpine/Busybox) ä¸Šç¨³å®šè¿è¡Œã€‚
* **å®‰å…¨æ¶æ„ (Fortress Pro)**:
    * **æ‰˜ç®¡é…ç½®å—**: ä½¿ç”¨ `# BEGIN SERVER-INIT MANAGED BLOCK` å¤´éƒ¨æ’å…¥é…ç½®ï¼Œç¡®ä¿ä¼˜å…ˆçº§æœ€é«˜ï¼Œä¸å— `Include` æŒ‡ä»¤å¹²æ‰°ã€‚
    * **è‡ªåŠ¨å›æ»š (Auto-Rollback)**: è¿è¡Œæ—¶è‹¥å‘ç”Ÿ SSHD æ ¡éªŒå¤±è´¥ã€ç«¯å£æœªç›‘å¬æˆ–è¿æ¥æµ‹è¯•å¤±è´¥ï¼Œè‡ªåŠ¨è¿˜åŸç³»ç»ŸçŠ¶æ€ã€‚
    * **è¿›ç¨‹é˜²æ€ (Anti-Kill)**: ä¸º SSHD æœåŠ¡æ·»åŠ  systemd `override.conf`ï¼Œé˜²æ­¢ OOM è¯¯æ€å¹¶é…ç½®è‡ªåŠ¨é‡å¯ã€‚
    * **é˜²å¤±è”æ­»é”æ£€æµ‹**: æ™ºèƒ½æ£€æµ‹è®¤è¯æ–¹å¼ï¼Œé˜²æ­¢å‡ºç°â€œæ—¢ç¦ç”¨å¯†ç åˆæœªé…å¥½å¯†é’¥â€çš„æ­»é”ã€‚
* **è‡ªåŠ¨åŒ–å‹å¥½**:
    * æ”¯æŒ **æ— å¤´æ¨¡å¼ (Headless)**ï¼Œé€šè¿‡å‘½ä»¤è¡Œå‚æ•°å®ç°é›¶äº¤äº’æ— äººå€¼å®ˆå®‰è£…ã€‚
    * **å®¡è®¡ä¸æŠ¥å‘Š**: è‡ªåŠ¨ç”Ÿæˆè¯¦ç»†çš„æ“ä½œå®¡è®¡æ—¥å¿—ä¸ç³»ç»Ÿå¥åº·æ£€æŸ¥æŠ¥å‘Šã€‚

### ğŸš€ å¿«é€Ÿå¼€å§‹

è¯·ä»¥ **root** èº«ä»½è¿è¡Œã€‚

#### 1. äº¤äº’å¼è¿è¡Œ (æ¨è)
```bash
curl -fsSL https://raw.githubusercontent.com/jet3918/linux-ssh-init-sh/main/init.sh -o init.sh && chmod +x init.sh && ./init.sh
```

#### 2. å¼ºåˆ¶ä½¿ç”¨è‹±æ–‡ç•Œé¢
```bash
./init.sh --lang=en
```

### ğŸ¤– è‡ªåŠ¨åŒ–éƒ¨ç½² (æ— å¤´æ¨¡å¼)

é€‚ç”¨äº CI/CD æˆ–æ‰¹é‡è£…æœºåœºæ™¯ã€‚ä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°ä¼ é€’é…ç½®ï¼Œé…åˆ `--yes` è·³è¿‡ç¡®è®¤ã€‚

#### å…¨è‡ªåŠ¨è¿è¡Œç¤ºä¾‹
*(é…ç½® Root ç”¨æˆ·ã€éšæœºç«¯å£ã€ä» GitHub æ‹‰å–å…¬é’¥ã€å¼€å¯ BBRã€æ›´æ–°ç³»ç»Ÿã€è‡ªåŠ¨ç¡®è®¤)*

```bash
curl -fsSL https://raw.githubusercontent.com/jet3918/linux-ssh-init-sh/main/init.sh | sh -s -- \
    --user=root \
    --port=random \
    --key-gh=jet3918 \
    --bbr \
    --update \
    --strict \
    --yes
```

#### åŠè‡ªåŠ¨ç¤ºä¾‹
*(æŒ‡å®šå…¬é’¥æ¥æºï¼Œå…¶ä»–é€‰é¡¹æ‰‹åŠ¨é€‰æ‹©)*

```bash
./init.sh --key-url=https://my-server.com/id_ed25519.pub
```

### âš™ï¸ å‚æ•°è¯¦è§£

è„šæœ¬æ”¯æŒä¸°å¯Œçš„å‘½ä»¤è¡Œå‚æ•°æ¥æ§åˆ¶è¡Œä¸ºï¼š

| å‚æ•°ç±»åˆ« | å‚æ•° | è¯´æ˜ |
| :--- | :--- | :--- |
| **åŸºç¡€æ§åˆ¶** | `--lang=en` | å¼ºåˆ¶ä½¿ç”¨è‹±æ–‡ç•Œé¢ |
| | `--yes` | **è‡ªåŠ¨ç¡®è®¤**ï¼šè·³è¿‡è„šæœ¬æœ€åçš„ "ç¡®è®¤æ‰§è¡Œ?" è¯¢é—® |
| | `--strict` | **ä¸¥æ ¼æ¨¡å¼**ï¼šé‡åˆ°ä»»ä½•é”™è¯¯ç«‹å³é€€å‡º (è¯¦è§ä¸‹æ–¹) |
| | `--delay-restart` | **å»¶è¿Ÿé‡å¯**ï¼šä¿®æ”¹é…ç½®ä½†ä¸é‡å¯ SSH æœåŠ¡ (é€‚ç”¨äºç‰¹æ®Šç¯å¢ƒ) |
| **ç”¨æˆ·ä¸ç«¯å£** | `--user=root` | æŒ‡å®šç™»å½•ç”¨æˆ· (root æˆ–æ™®é€šç”¨æˆ·å) |
| | `--port=22` | ä¿æŒé»˜è®¤ 22 ç«¯å£ |
| | `--port=random` | ç”Ÿæˆéšæœºé«˜ä½ç«¯å£ (49152-65535) |
| | `--port=2222` | æŒ‡å®šå…·ä½“ç«¯å£å· |
| **å¯†é’¥æ¥æº** | `--key-gh=username` | ä» GitHub ç”¨æˆ·æ‹‰å–å…¬é’¥ |
| | `--key-url=url` | ä»æŒ‡å®š URL ä¸‹è½½å…¬é’¥ |
| | `--key-raw="ssh-..."` | ç›´æ¥ä¼ é€’å…¬é’¥å†…å®¹å­—ç¬¦ä¸² |
| **ç³»ç»Ÿé€‰é¡¹** | `--update` | å¼€å¯ç³»ç»Ÿè½¯ä»¶åŒ…æ›´æ–° |
| | `--no-update` | è·³è¿‡ç³»ç»Ÿæ›´æ–° |
| | `--bbr` | å¼€å¯ TCP BBR æ‹¥å¡æ§åˆ¶ |
| | `--no-bbr` | ä¸å¼€å¯ BBR |

### âš™ï¸ æ™®é€šæ¨¡å¼ vs ä¸¥æ ¼æ¨¡å¼

| åœºæ™¯ | æ™®é€šæ¨¡å¼ (é»˜è®¤) | ä¸¥æ ¼æ¨¡å¼ (`--strict`) |
| :--- | :--- | :--- |
| **è®¾è®¡ç†å¿µ** | **"ä¼˜å…ˆä¿å‘½"** (å°½åŠ›è€Œä¸º) | **"ä¼˜å…ˆåˆè§„"** (é›¶å®¹å¿) |
| **å…¬é’¥å¤±è´¥** | è‹¥ä¸‹è½½å¤±è´¥ï¼Œè„šæœ¬**ä¿ç•™å¯†ç ç™»å½•**å¹¶è­¦å‘Šã€‚<br>ğŸ‘‰ *ç»“æœï¼šæœåŠ¡å™¨ä¸å®‰å…¨ï¼Œä½†èƒ½ç™»å½•ä¿®è¡¥ã€‚* | è„šæœ¬**ç«‹å³æŠ¥é”™é€€å‡º**ï¼Œä¸ä¿®æ”¹ä»»ä½•é…ç½®ã€‚<br>ğŸ‘‰ *ç»“æœï¼šéƒ¨ç½²ä¸­æ–­ï¼Œä¿æŒåŸæ ·ã€‚* |
| **ç«¯å£å¤±è´¥** | è‹¥éšæœºç«¯å£å¤±è´¥ï¼Œå›é€€ä½¿ç”¨ **ç«¯å£ 22**ã€‚ | è„šæœ¬**ç«‹å³æŠ¥é”™é€€å‡º**ã€‚ |

### ğŸ“‚ æ—¥å¿—ä¸å®¡è®¡

è„šæœ¬æ‰§è¡Œåä¼šç”Ÿæˆä»¥ä¸‹é‡è¦æ–‡ä»¶ï¼Œç”¨äºæ’æŸ¥é—®é¢˜æˆ–å®¡è®¡åˆè§„ï¼š

* **è¿è¡Œæ—¥å¿—**: `/var/log/server-init.log` (åŒ…å«è¯¦ç»†çš„ debug ä¿¡æ¯)
* **å®¡è®¡æ—¥å¿—**: `/var/log/server-init-audit.log` (è®°å½•å…³é”®æ“ä½œ Actionã€æ—¶é—´æˆ³åŠæ“ä½œäºº)
* **å¥åº·æŠ¥å‘Š**: `/var/log/server-init-health.log` (æœ€ç»ˆçš„ç³»ç»Ÿé…ç½®çŠ¶æ€å¿«ç…§)

### ğŸ†˜ ç¾éš¾æ¢å¤ä¸é…ç½®è¿˜åŸ

è„šæœ¬æ‹¥æœ‰ä¸¤å±‚å®‰å…¨æœºåˆ¶ï¼š**è¿è¡Œæ—¶è‡ªåŠ¨å›æ»š** å’Œ **æŒä¹…åŒ–å¤‡ä»½æ¢å¤**ã€‚

å¦‚æœåœ¨è„šæœ¬æ‰§è¡Œå®Œæˆåï¼ˆæ˜¾ç¤º "DONE" åï¼‰æ‚¨æ— æ³•è¿æ¥æœåŠ¡å™¨ï¼Œè¯·é€šè¿‡äº‘æœåŠ¡å•†çš„ VNC / Console æ§åˆ¶å°ç™»å½•ï¼Œå¹¶ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•æ¢å¤ã€‚

#### æ–¹æ³• Aï¼šä½¿ç”¨ä¸€é”®æ¢å¤è„šæœ¬ (æ¨è)

è„šæœ¬åœ¨ä¿®æ”¹å‰ä¼šè‡ªåŠ¨åˆ›å»ºå¤‡ä»½ï¼Œå¹¶ç”Ÿæˆæ¢å¤è„šæœ¬ã€‚

1.  æ‰¾åˆ°æœ€è¿‘çš„å¤‡ä»½ç›®å½•ï¼š
    ```bash
    ls -ld /var/backups/ssh-config/*
    ```
2.  è¿›å…¥ç›®å½•å¹¶è¿è¡Œæ¢å¤è„šæœ¬ï¼š
    ```bash
    # è¿›å…¥æœ€æ–°çš„å¤‡ä»½ç›®å½• (ä¾‹å¦‚ 20250520_120000)
    cd /var/backups/ssh-config/<TIMESTAMP>/
    
    # æ‰§è¡Œæ¢å¤
    sh restore.sh
    ```
    *è¯¥è„šæœ¬ä¼šè‡ªåŠ¨è¦†ç›– sshd_config å¹¶å°è¯•é‡å¯ SSH æœåŠ¡ã€‚*

#### æ–¹æ³• Bï¼šæ‰‹åŠ¨æ¢å¤

å¦‚æœæ— æ³•è¿è¡Œè„šæœ¬ï¼Œå¯æ‰‹åŠ¨å¤åˆ¶æ–‡ä»¶ï¼š

```bash
# 1. è¦†ç›–é…ç½®æ–‡ä»¶
cp /var/backups/ssh-config/<TIMESTAMP>/sshd_config /etc/ssh/sshd_config

# 2. é‡å¯æœåŠ¡
systemctl restart sshd || service sshd restart
```

---

### âš ï¸ å…è´£å£°æ˜

æœ¬è„šæœ¬ä¼šä¿®æ”¹æ ¸å¿ƒç³»ç»Ÿé…ç½®ï¼ˆSSHï¼‰ã€‚è™½ç„¶è„šæœ¬å†…ç½®äº†å¤šé‡å®‰å…¨æ£€æŸ¥å’Œå›æ»šæœºåˆ¶ï¼Œä½†è¯·åŠ¡å¿…ç¡®ä¿ä½ æ‹¥æœ‰æœåŠ¡å™¨çš„å¤‡ç”¨è®¿é—®æ–¹å¼ï¼ˆå¦‚ VNC æ§åˆ¶å°ï¼‰ï¼Œä»¥é˜²ç½‘ç»œæ³¢åŠ¨æˆ–é…ç½®æ„å¤–å¯¼è‡´çš„è¿æ¥ä¸­æ–­ã€‚

### ğŸ“„ å¼€æºåè®®

æœ¬é¡¹ç›®é‡‡ç”¨ [MIT License](LICENSE) å¼€æºã€‚

---

<div align="center">

å¦‚æœæ‚¨è§‰å¾—è¿™ä¸ªå·¥å…·å¥½ç”¨ï¼Œè¯·ç»™ä¸€é¢— â­ æ˜Ÿï¼

[æŠ¥å‘Šé—®é¢˜](https://github.com/247like/linux-ssh-init-sh/issues) Â· [åŠŸèƒ½å»ºè®®](https://github.com/247like/linux-ssh-init-sh/issues)

</div>
